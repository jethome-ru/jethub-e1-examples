# Базовая конфигурация ESPHome для контроллера JetHub E1 на базе платы PD76-R5 v.2.x

Изменения в ревизии 2.x:

  * Добавлена клемма 1-wire, на которую выведен вывод GPIO16 микроконтроллера;
  * Вместо внутренних разъемов JXM, UART, IO установлен внутренний 6-контактный разъем (контакты на плате) на который выведены: GPIO33, GPIO34, GPIO32 и GPIO15.

Пример файла конфигурации [YAML](e1-pd76-r5-basic-v2.yaml).

В данной конфигурации реализовано:

  * Подключение по интерфейсу Ethernet с автоматическим определением IP-адреса;
  * Интеграция с Home Assistant;
  * Управление двумя светодиодами STAT (красный и зеленый), выведенных на лицевую панель контроллера;
  * Управление всеми реле;
  * Определение событий от кнопки FN, установленной на лицевой панели контроллера;
  * Определение событий от всех дискретных входов;
  * Шина 1-wire.

После загрузки контроллера и получения IP-адреса контроллер будет автоматически доступен в Home Assistant, работающем в этой же сети.

## Комментарии к конфигурации

### Базовые настройки

Задают имя контроллера, тип аппаратной платформы:

```
esphome:
  name: e1-pd76-r5
  platform: ESP32
  board: nodemcu-32s
  name_add_mac_suffix: true
```

Опция `name_add_mac_suffix` добавляет к базовому имени контроллера `e1-pd76-r5` часть MAC-адреса, что гарантирует уникальность имени контроллера в сети.

### Сетевые настройки

Задаются настройки подключения Ethernet PHY и подключение по интерфейсу Ethernet с автоматическим определением IP-адреса:

```
ethernet:
  type: LAN8720
  mdc_pin: GPIO23
  mdio_pin: GPIO18
  clk_mode: GPIO17_OUT
  phy_addr: 1
```

## Шина I2C

Шина I2C выведена на пины IO4, IO5 ESP32. Включено сканирование устройств на шине при загрузке контроллера (данная опция не обязательна. Информация об обнаруженных на шине устройствах выводится в лог и может быть использована для отладки):

```
i2c:
  sda: 5
  scl: 4
  frequency: 400kHz
  scan: true
  id: i2c1
```

### Расширитель портов GPIO

Часть периферии контроллера подключено к расширителям портов GPIO, подключенных к шине I2C.

Светодиоды и одна опциональная кнопка (USER button) подключены к расширителю портов GPIO, установленному на процессорном модуле плате. Адрес на шине I2C - 0x20.

Реле и дискретные входы подключены к расширителю портов GPIO, установленному на периферийной (материнской) плате. Адрес на шине I2C - 0x22.

```
pcf8574:
  - id: cpu_gpio_exp
    address: 0x20
    pcf8575: true
  - id: mb_gpio_exp
    address: 0x22
    pcf8575: true
```

### Реле

Реле подключены к расширителю портов на периферийной плате. Для управления реле используется инверсная логика.

Пример конфигурации релейного выхода:

```
switch:
  - platform: gpio
    name: "Relay 1"
    id: relay_1
    pin:
      pcf8574: mb_gpio_exp
      number: 8
      mode: OUTPUT
      inverted: true
```

При изменении состояния выходов реле, через некоторое время (~40 сек) ESPHome по умолчанию автоматически сохраняет их состояние и после перезагрузки восстанавливает состояния выходов на сохраненные. Если данный функционал не нужен, то необходимо изменить эту функцию, задав состояние выхода при загрузке с помощью опции "restore_mode", например:

```
switch:
  - platform: gpio
    name: "Relay 1"
    id: relay_1
    restore_mode: ALWAYS_OFF
    ...
```

### Дискретные входы

Дискретные входы подключены к расширителю портов на периферийной плате. Пример конфигурации дискретного входа:

```
binary_sensor:
  - platform: gpio
    name: "Input 1"
    pin:
      pcf8574: mb_gpio_exp
      number: 0
      inverted: false
```

### Светодиоды

Светодиоды подключены к расширителю портов на процессорном модуле. Для управления светодиодами используется инверсная логика.

Пример конфигурации для светодиодов:

```
switch:
  - platform: gpio
    name: "Red LED"
    id: red_led
    pin:
      pcf8574: cpu_gpio_exp
      number: 0
      mode: OUTPUT
      inverted: true
  - platform: gpio
    name: "Green LED"
    id: green_led
    pin:
      pcf8574: cpu_gpio_exp
      number: 1
      mode: OUTPUT
      inverted: true
```

### Кнопка

Пример конфигурации для кнопки FN:

```
binary_sensor:
  - platform: gpio
    name: "FN button"
    pin:
      number: 0
      inverted: true
```

### 1-wire

Шина 1-wire подключена к выводу GPIO16 микроконтроллера. Задействование шины 1-wire в файле конфигурации:

```
dallas:
  - pin: 16
```

Для каждого подключенного к шине датчика температуры необходимо добавить в файл конфигурации:

```
sensor:
  - platform: dallas
    address: 0x1c0000031edd2a28
    name: "Livingroom Temperature"
```

### UART

Пример конфигурирования порта UART, выведенного на внутренние контакты платы PD76-R5:

```
uart:
  - tx_pin: 33
    rx_pin: 34
    baud_rate: 115200
    id: uart1
```

### Интеграция с Home Assistant

Для интеграции контроллера в систему Home Assistant достаточно включить в файле конфигурации секцию api:

```
api:
```

При этом после загрузки и подключения к сети контроллер будет автоматически доступен в системе Home Assistant, работающей в данной сети.

Подробную документаци по работе ESPHome совместно с Home Assistant смотри в документации ESPHome: [Native API Component](https://esphome.io/components/api.html)

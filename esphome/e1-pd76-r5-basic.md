# Базовая конфигурация ESPHome для контроллера JetHub E1 PD76-R5

Файл конфигурации [YAML](e1-pd76-r5-basic.yaml).

В данной конфигурации реализовано:

  * Подключение по интерфейсу Ethernet с автоматическим определением IP-адреса;
  * Интеграция с Home Assistant;
  * Управление двумя светодиодами STAT (красный и зеленый);
  * Управление всеми реле;
  * Определение событий от кнопки FN;
  * Определение событий от всех дискретных входов.

Если вы используете более одного контроллера в сети необходимо изменить:

  * Имя контроллера (параметр name в секции esphome). По умолчанию имя контроллера установлено в "e1-pd76-r5";
  * При необходимости изменить имена для реле и дискретных входов, которые будт отображаться в Home Assistant. По умолчанию заданы имена: "Relay 1" ... "Relay 5", "Input 1" ... "Input 6".

После загрузки контроллера и получения IP-адреса контроллер будет автоматически доступен в Home Assistant, работающем в этой же сети.

## Комментарии к конфигурации

### Базовые настройки

Задают имя контроллера, тип аппаратной платформы:

```
esphome:
  name: e1-pd76-r5
  platform: ESP32
  board: nodemcu-32s
```

### Сетевые настройки

Задаются настройки подключения Ethernet PHY и подключение по интерфейсу Ethernet с автоматическим определением IP-адреса:

```
ethernet:
  type: LAN8720
  mdc_pin: GPIO23
  mdio_pin: GPIO18
  clk_mode: GPIO17_OUT
  phy_addr: 1
```

## Шина I2C

Шина I2C выведена на пины IO4, IO5 ESP32. Включено сканирование устройств на шине при загрузке контроллера (данная опция не обязательна. Информация об обнаруженных на шине устройствах выводится в лог и может быть использована для отладки):

```
i2c:
  sda: 5
  scl: 4
  frequency: 400kHz
  scan: true
  id: i2c1
```

### Расширитель портов GPIO

Часть периферии контроллера подключено к расширителям портов GPIO, подключенных к шине I2C.

Светодиоды и одна опциональная кнопка (USER button) подключены к расширителю портов GPIO, установленному на процессорном модуле плате. Адрес на шине I2C - 0x20.

Реле и дискретные входы подключены к расширителю портов GPIO, установленному на периферийной (материнской) плате. Адрес на шине I2C - 0x22.

```
pcf8574:
  - id: cpu_gpio_exp
    address: 0x20
    pcf8575: true
  - id: mb_gpio_exp
    address: 0x22
    pcf8575: true
```

### Реле

Реле подключены к расширителю портов на периферийной плате. Для управления реле используется инверсная логика.

Пример конфигурации релейного выхода:

```
switch:
  - platform: gpio
    name: "Relay 1"
    id: relay_1
    pin:
      pcf8574: mb_gpio_exp
      number: 8
      mode: OUTPUT
      inverted: true
```

При изменении состояния выходов реле, через некоторое время (~40 сек) ESPHome по умолчанию автоматически сохраняет их состояние и после перезагрузки восстанавливает состояния выходов на сохраненные. Если данный функционал не нужен, то необходимо изменить эту функцию, задав состояние выхода при загрузке с помощью опции "restore_mode", например:

```
switch:
  - platform: gpio
    name: "Relay 1"
    id: relay_1
    restore_mode: ALWAYS_OFF
    ...
```

### Дискретные входы

Дискретные входы подключены к расширителю портов на периферийной плате. Пример конфигурации дискретного входа:

```
binary_sensor:
  - platform: gpio
    name: "Input 1"
    pin:
      pcf8574: mb_gpio_exp
      number: 0
      inverted: false
```

### Светодиоды

Светодиоды подключены к расширителю портов на процессорном модуле. Для управления светодиодами используется инверсная логика.

Пример конфигурации для светодиодов:

```
switch:
  - platform: gpio
    name: "Red LED"
    id: red_led
    pin:
      pcf8574: cpu_gpio_exp
      number: 0
      mode: OUTPUT
      inverted: true
  - platform: gpio
    name: "Green LED"
    id: green_led
    pin:
      pcf8574: cpu_gpio_exp
      number: 1
      mode: OUTPUT
      inverted: true
```

### Кнопка

Пример конфигурации для кнопки FN:

```
binary_sensor:
  - platform: gpio
    name: "FN button"
    pin:
      number: 0
      inverted: true
```

 В ревизии 1.1 процессорный модуль E1-CPU имеет дополнительную внутреннюю пользовательскую кнопку (USER button), подключенную к расширителю портов. Для задействования данной кнопки нужно добавить в файл конфигурации:

```
binary_sensor:
  - platform: gpio
    name: "USER button"
    pin:
      pcf8574: cpu_gpio_exp
      number: 2
      inverted: true
```

### Интеграция с Home Assistant

Для интеграции контроллера в систему Home Assistant достаточно включить в файле конфигурации секцию api:

```
api:
```

При этом после загрузки и подключения к сети контроллер будет автоматически доступен в системе Home Assistant, работающей в данной сети.

Подробную документаци по работе ESPHome совместно с Home Assistant смотри в документации ESPHome: [Native API Component](https://esphome.io/components/api.html)

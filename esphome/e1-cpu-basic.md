# Базовая конфигурация ESPHome для процессорного модуля JetHub E1-CPU

Файл конфигурации [YAML](e1-cpu-basic.yaml).

В данной конфигурации реализованы:

  * Настройка Ethernet с автоматическим определением IP-адреса;
  * Интеграция с Home Assistant;
  * Настройка светодиодов STAT (красный и зеленый);
  * Настройка кнопки FN;
  * Настройка интерфейсов: I2C, UART, SPI, CAN.

## Комментарии к конфигурации

### Шина I2C

Пример конфигурации для шины I2C. К данной шине подключены: расширитель портов GPIO, EEPROM и RTC. Шина также выведенных на разъем расширения.

```
i2c:
  sda: 5
  scl: 4
  frequency: 400kHz
  scan: true
  id: i2c1
```

### Порты UART

Пример конфигурации для двух портов UART, выведенных на разъем расширения:

```
uart:
  - tx_pin: 33
    rx_pin: 34
    baud_rate: 115200
    id: uart1
  - tx_pin: 2
    rx_pin: 39
    baud_rate: 115200
    id: uart1
```

### Шина SPI

Пример конфигурации для шины SPI, выведенной на разъем расширения:

```
spi:
  clk_pin: 14
  mosi_pin: 13
  miso_pin: 12
  id: spi1
```

### Расширитель портов GPIO

Светодиоды подключены к расширителю портов GPIO, установленному на процессорной плате. Поэтому предварительно должен быть настроен расширитель портов PCF8575. Адрес на шине I2C - 0x20.

```
pcf8574:
  - id: cpu_gpio_exp
    address: 0x20
    pcf8575: true
```

### Светодиоды

Для управления светодиодами используется инверсная логика.

Пример конфигурации для светодиодов:

```
switch:
  - platform: gpio
    name: "Red LED"
    id: red_led
    pin:
      pcf8574: cpu_gpio_exp
      number: 0
      mode: OUTPUT
      inverted: true
  - platform: gpio
    name: "Green LED"
    id: green_led
    pin:
      pcf8574: cpu_gpio_exp
      number: 1
      mode: OUTPUT
      inverted: true
```

При изменении состояния выходов, через некоторое время (~40 сек) ESPHome по умолчанию автоматически сохраняет их состояние и после перезагрузки восстанавливает состояния выходов на сохраненные ранее. Если данный функционал не нужен, то необходимо изменить эту функцию, задав состояние выхода при загрузке с помощью опции "restore_mode", например:

```
switch:
  - platform: gpio
    ...
    restore_mode: ALWAYS_OFF
    ...
```

### Кнопка

Пример конфигурации для кнопки FN:

```
binary_sensor:
  - platform: gpio
    name: "FN button"
    pin:
      number: 0
      inverted: true
    on_press:
      then:
        - switch.toggle: green_led
```
В данном примере при нажатие кнопки будет приводить к включению/отключению зеленого светодиода.

В ревизии 1.1 процессорный модуль E1-CPU имеет дополнительную внутреннюю пользовательскую кнопку, подключенную к расширителю портов. Пример конфигурации для пользовательской кнопки:

```
binary_sensor:
  - platform: gpio
    name: "USER button"
    pin:
      pcf8574: cpu_gpio_exp
      number: 2
      inverted: true
```

В ревизии 1.2 процессорного модуля внутренняя кнопка выполняет функцию аппаратного сброса контроллера (RESET).

### Шина CAN

Предусмотрена возможность вывести шину CAN на разъем расширения, для этого рекумендуется использовать выводы 32 и 15 ESP32. Пример конфигурации шины CAN:

```
canbus:
  - platform: esp32_can
    id: can1
    tx_pin: 32
    rx_pin: 15
    can_id: 1
    bit_rate: 125KBPS
```
